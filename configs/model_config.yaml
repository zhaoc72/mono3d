# DINOv3 官方代码配置 (ViT-7B/16 + 多GPU支持)

model:
  name: "dinov3_official"
  
  # ============================================
  # DINOv3 Official 配置
  # ============================================
  dinov3_official:
    # 官方代码路径
    repo_dir: "/media/pc/D/zhaochen/mono3d/dinov3"
    
    # Backbone 配置
    backbone:
      model_name: "dinov3_vit7b16"
      checkpoint_path: "/media/pc/D/zhaochen/mono3d/dinov3/checkpoints/dinov3_vit7b16_lvd1689m.pth"
    
    # Detection 配置
    detection:
      model_name: "dinov3_vit7b16_de"  # COCO detector
      checkpoint_path: "/media/pc/D/zhaochen/mono3d/dinov3/checkpoints/dinov3_vit7b16_coco.pth"
      score_threshold: 0.1
    
    # Segmentation 配置
    segmentation:
      model_name: "dinov3_vit7b16_ms"  # ADE20K segmentor
      checkpoint_path: "/media/pc/D/zhaochen/mono3d/dinov3/checkpoints/dinov3_vit7b16_ade20k.pth"
      num_classes: 150
      inference_mode: "slide"  # 滑窗推理
      decoder_head_type: "m2f"  # Mask2Former
    
    # 多GPU配置
    multi_gpu:
      enabled: true
      num_gpus: 4
      device_ids: [0, 1, 2, 3]
      # 模型并行策略：将大模型拆分到多张卡
      strategy: "model_parallel"  # model_parallel 或 data_parallel
      
      # 显存分配 (每张卡预留的显存)
      max_memory:
        0: "18GiB"
        1: "18GiB"
        2: "18GiB"
        3: "18GiB"
        cpu: "100GiB"
    
    # 推理配置
    inference:
      image_size: 896  # 推理分辨率
      dtype: "bfloat16"  # bfloat16 或 float16
      crop_size: [896, 896]
      stride: [896, 896]

# ============================================
# Fusion 配置
# ============================================
fusion:
  objectness_threshold: 0.4
  segmentation_threshold: 0.3
  detection_score_threshold: 0.05
  min_instance_area: 100
  dilation_kernel: 3
  nms_iou_threshold: 0.6

# ============================================
# Prompt 生成配置
# ============================================
prompts:
  include_points: true
  include_boxes: true
  include_masks: true
  max_points_per_region: 3
  min_score: 0.1
  max_prompts: 50
  max_prompts_per_class: 5
  nms_iou_threshold: 0.5

# ============================================
# Instance Grouping 配置
# ============================================
instance_grouping:
  method: "connected_components"
  min_area: 100

# ============================================
# 后处理配置
# ============================================
postprocess:
  enable: true
  closing_kernel: 5
  opening_kernel: 3
  min_instance_area: 100

# ============================================
# SAM2 配置
# ============================================
sam2:
  backend: "official"
  checkpoint_path: "/media/pc/D/zhaochen/mono3d/sam2/checkpoints/sam2.1_hiera_large.pt"
  model_config: "sam2.1/sam2.1_hiera_l"
  max_batch_size: 32
  mask_selection_strategy: "best_balanced"
  multimask_output: true