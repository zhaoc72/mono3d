# DINOv3 配置文件（修正版）
# 使用实际的文件路径

model:
  name: "dinov3_adapter"
  
  # ============================================
  # DINOv3 Backbone 配置
  # ============================================
  backbone:
    type: "dinov3"
    
    # Model paths
    repo_path: "/media/pc/D/zhaochen/mono3d/dinov3"
    model_name: "dinov3_vit7b16"
    checkpoint_path: "/media/pc/D/zhaochen/mono3d/dinov3/checkpoints/dinov3_vit7b16_lvd1689m.pth"
    
    # Model architecture
    patch_size: 16
    embed_dim: 4096
    num_heads: 32
    num_layers: 40
    image_size: 518
    
    # Training settings
    freeze: true
    
    # Memory optimization settings (NEW)
    memory_efficient_attention: true    # Enable memory efficient attention
    gradient_checkpointing: false       # Enable if training, disable for inference
    cpu_offload: false                  # Offload model to CPU between forward passes
    load_in_8bit: false                 # Use 8-bit quantization (experimental)
    
    # Feature extraction settings
    output_layers: [9, 19, 29, 39]
    layer_weights: [1.0, 1.0, 1.0, 1.0]
    fusion_method: "weighted_sum"
    
    # PCA and objectness
    enable_objectness: true
    enable_pca: false
    pca_dim: 64
    
    # Positional features
    append_positional_features: true
    positional_feature_scale: 1.0
    
    # Objectness post-processing
    objectness_smoothing_kernel: 5
    objectness_contrast_gamma: 2.0
    
    # Device settings
    dtype: "float16"  # Use float16 to save memory (was float32)
    device: "cuda"    # Will auto-detect multi-GPU

  # Alternative configurations for different scenarios:

  # Configuration 1: Maximum memory saving (slower)
  # dtype: "float16"
  # memory_efficient_attention: true
  # cpu_offload: true
  # gradient_checkpointing: true

  # Configuration 2: Balanced (recommended for 4x24GB GPUs)
  # dtype: "float16"
  # memory_efficient_attention: true
  # cpu_offload: false
  # gradient_checkpointing: false

  # Configuration 3: Use smaller model
  # model_name: "dinov3_vitl16"  # Large instead of 7B
  # checkpoint_path: "/path/to/dinov3_vitl16.pth"
  
  # ============================================
  # Detection Adapter 配置
  # ============================================
  detection_adapter:
    type: "detr_head"
    
    # Detection adapter 权重路径
    checkpoint_path: "/media/pc/D/zhaochen/mono3d/dinov3/checkpoints/dinov3_vit7b16_coco.pth"
    
    freeze: false  # adapter 需要训练/微调
    
    # COCO 检测配置
    feature_dim: 3200  # 输入特征维度（与 backbone 一致）
    num_classes: 91  # COCO 数据集类别数（80 类 + 背景）
    
    # DETR 架构
    hidden_dim: 256
    num_queries: 300
    nheads: 8
    num_encoder_layers: 6
    num_decoder_layers: 6
    dim_feedforward: 2048
    dropout: 0.1
    
    # 推理配置
    score_threshold: 0.05  # 降低阈值以获得更多检测
    aux_loss: true
    use_objectness: true
  
  # ============================================
  # Segmentation Adapter 配置
  # ============================================
  segmentation_adapter:
    type: "mask_head"
    
    # Segmentation adapter 权重路径
    checkpoint_path: "/media/pc/D/zhaochen/mono3d/dinov3/checkpoints/dinov3_vit7b16_ade20k.pth"
    
    freeze: false  # adapter 需要训练/微调
    
    # ADE20K 分割配置
    feature_dim: 3200  # 输入特征维度（与 backbone 一致）
    num_classes: 150  # ADE20K 数据集类别数
    
    # Mask 解码器
    hidden_dim: 256
    num_mask_tokens: 100
    mask_dim: 256
    
    # FPN 配置
    use_fpn: true
    fpn_scales: [8, 16, 32]

# ============================================
# Fusion 配置
# ============================================
fusion:
  objectness_threshold: 0.45
  segmentation_threshold: 0.35
  detection_score_threshold: 0.05  # 与 detection_adapter.score_threshold 一致
  min_instance_area: 60
  dilation_kernel: 3
  nms_iou_threshold: 0.6

# ============================================
# Prompt 生成配置
# ============================================
prompts:
  include_points: true
  include_boxes: true
  include_masks: true
  max_points_per_region: 3
  grid_points_per_side: 0
  min_score: 0.0
  max_prompts: 128
  max_prompts_per_class: 0
  nms_iou_threshold: 0.5

# ============================================
# Instance Grouping 配置
# ============================================
instance_grouping:
  method: "connected_components"
  min_area: 60
  use_density_clustering: false

# ============================================
# 后处理配置
# ============================================
postprocess:
  enable: true
  closing_kernel: 5
  opening_kernel: 3
  min_instance_area: 60

# ============================================
# SAM2 配置
# ============================================
sam2:
  backend: "official"
  checkpoint_path: "/media/pc/D/zhaochen/mono3d/sam2/checkpoints/sam2.1_hiera_large.pt"
  model_config: "sam2.1/sam2.1_hiera_l"
  max_batch_size: 32
  
  # Mask 选择策略
  mask_selection_strategy: "best_balanced"
  multimask_output: true

# ============================================
# 推理配置
# ============================================
inference:
  device: "cuda"
  dtype: "float32"
  batch_size: 1
  
  # 图像预处理
  image_size: [518, 518]  # [height, width]
  normalize:
    mean: [0.485, 0.456, 0.406]
    std: [0.229, 0.224, 0.225]