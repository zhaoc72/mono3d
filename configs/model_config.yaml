# DINOv3 é…ç½®æ–‡ä»¶ï¼ˆä¿®å¤ç‰ˆ - é€‚é…å™¨éšæœºåˆå§‹åŒ–ï¼‰
# è§£å†³æ¶æ„ä¸åŒ¹é…é—®é¢˜

model:
  name: "dinov3_adapter"
  
  # ============================================
  # DINOv3 Backbone é…ç½®
  # ============================================
  backbone:
    type: "dinov3"
    
    # Model paths
    repo_path: "/media/pc/D/zhaochen/mono3d/dinov3"
    model_name: "dinov3_vit7b16"
    checkpoint_path: "/media/pc/D/zhaochen/mono3d/dinov3/checkpoints/dinov3_vit7b16_lvd1689m.pth"
    
    # Model architecture
    patch_size: 16
    embed_dim: 4096
    num_heads: 32
    num_layers: 40
    image_size: 518
    
    # Training settings
    freeze: true
    
    # Memory optimization settings
    memory_efficient_attention: true
    gradient_checkpointing: false
    cpu_offload: false
    load_in_8bit: false
    
    # Feature extraction settings
    output_layers: [9, 19, 29, 39]
    layer_weights: [1.0, 1.0, 1.0, 1.0]
    fusion_method: "weighted_sum"
    
    # PCA and objectness
    enable_objectness: true
    enable_pca: false
    pca_dim: 64
    
    # Positional features
    append_positional_features: true
    positional_feature_scale: 1.0
    
    # Objectness post-processing
    objectness_smoothing_kernel: 5
    objectness_contrast_gamma: 2.0
    
    # Device settings
    dtype: "float16"
    device: "cuda"
  
  # ============================================
  # Detection Adapter é…ç½®ï¼ˆéšæœºåˆå§‹åŒ–ï¼‰
  # ============================================
  detection_adapter:
    type: "detr_head"
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šä¸åŠ è½½é¢„è®­ç»ƒæƒé‡
    checkpoint_path: ""
    
    freeze: false
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šåŒ¹é… ViT-7B ç‰¹å¾ç»´åº¦
    feature_dim: 4096  # ä» 3200 æ”¹ä¸º 4096
    num_classes: 91
    
    # DETR æ¶æ„
    hidden_dim: 256
    num_queries: 300
    nheads: 8
    num_encoder_layers: 6
    num_decoder_layers: 6
    dim_feedforward: 2048
    dropout: 0.1
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæé«˜é˜ˆå€¼ï¼ˆéšæœºæƒé‡çš„åˆ†æ•°æ›´åˆ†æ•£ï¼‰
    score_threshold: 0.3  # ä» 0.05 æé«˜åˆ° 0.3
    aux_loss: true
    use_objectness: true
  
  # ============================================
  # Segmentation Adapter é…ç½®ï¼ˆéšæœºåˆå§‹åŒ–ï¼‰
  # ============================================
  segmentation_adapter:
    type: "mask_head"
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šä¸åŠ è½½é¢„è®­ç»ƒæƒé‡
    checkpoint_path: ""
    
    freeze: false
    
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šåŒ¹é… ViT-7B ç‰¹å¾ç»´åº¦
    feature_dim: 4096  # ä» 3200 æ”¹ä¸º 4096
    num_classes: 150
    
    # Mask è§£ç å™¨
    hidden_dim: 256
    num_mask_tokens: 100
    mask_dim: 256
    
    # FPN é…ç½®
    use_fpn: true
    fpn_scales: [8, 16, 32]

# ============================================
# Fusion é…ç½®ï¼ˆæé«˜é˜ˆå€¼ï¼‰
# ============================================
fusion:
  # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæé«˜é˜ˆå€¼ï¼Œæ›´ä¾èµ– objectness
  objectness_threshold: 0.5      # ä» 0.45 æé«˜åˆ° 0.5
  segmentation_threshold: 0.4    # ä» 0.35 æé«˜åˆ° 0.4
  detection_score_threshold: 0.3 # ä» 0.05 æé«˜åˆ° 0.3
  min_instance_area: 100         # ä» 60 æé«˜åˆ° 100
  dilation_kernel: 3
  nms_iou_threshold: 0.6

# ============================================
# Prompt ç”Ÿæˆé…ç½®
# ============================================
prompts:
  include_points: true
  include_boxes: true
  include_masks: true
  max_points_per_region: 3
  grid_points_per_side: 0
  min_score: 0.2                 # ä» 0.0 æé«˜åˆ° 0.2
  max_prompts: 50                # ä» 128 é™ä½åˆ° 50
  max_prompts_per_class: 5       # ä» 0 æ”¹ä¸º 5ï¼ˆé™åˆ¶æ¯ç±»æœ€å¤š5ä¸ªï¼‰
  nms_iou_threshold: 0.5

# ============================================
# Instance Grouping é…ç½®
# ============================================
instance_grouping:
  method: "connected_components"
  min_area: 100                  # ä» 60 æé«˜åˆ° 100
  use_density_clustering: false

# ============================================
# åå¤„ç†é…ç½®
# ============================================
postprocess:
  enable: true
  closing_kernel: 5
  opening_kernel: 3
  min_instance_area: 100         # ä» 60 æé«˜åˆ° 100

# ============================================
# SAM2 é…ç½®
# ============================================
sam2:
  backend: "official"
  checkpoint_path: "/media/pc/D/zhaochen/mono3d/sam2/checkpoints/sam2.1_hiera_large.pt"
  model_config: "sam2.1/sam2.1_hiera_l"
  max_batch_size: 32
  
  # Mask é€‰æ‹©ç­–ç•¥
  mask_selection_strategy: "best_balanced"
  multimask_output: true

# ============================================
# æ¨ç†é…ç½®
# ============================================
inference:
  device: "cuda"
  dtype: "float32"
  batch_size: 1
  
  # å›¾åƒé¢„å¤„ç†
  image_size: [518, 518]
  normalize:
    mean: [0.485, 0.456, 0.406]
    std: [0.229, 0.224, 0.225]

# ============================================
# é…ç½®è¯´æ˜
# ============================================
# 
# æœ¬é…ç½®é‡‡ç”¨"éšæœºåˆå§‹åŒ–é€‚é…å™¨"æ–¹æ¡ˆï¼Œç†ç”±ï¼š
# 
# 1. å®˜æ–¹é¢„è®­ç»ƒæƒé‡æ¶æ„ä¸åŒ¹é…ï¼š
#    - å®˜æ–¹ï¼šDeformable DETR (768ç»´hidden, å¤šå±‚å˜å½¢æ³¨æ„åŠ›)
#    - ç®€åŒ–ç‰ˆï¼šSimpleDETR (256ç»´hidden, å•å±‚ç¼–ç å™¨)
# 
# 2. ç®¡é“è®¾è®¡å“²å­¦ï¼š
#    - DINOv3 æä¾›é«˜è´¨é‡è¯­ä¹‰ç‰¹å¾ï¼ˆå·²é¢„è®­ç»ƒï¼‰
#    - é€‚é…å™¨ç”Ÿæˆç²—ç³™å€™é€‰åŒºåŸŸï¼ˆéšæœºåˆå§‹åŒ–å¯æ¥å—ï¼‰
#    - SAM2 è¿›è¡Œç²¾ç»†åˆ†å‰²ï¼ˆæœ€ç»ˆè´¨é‡ä¿è¯ï¼‰
# 
# 3. å…³é”®å‚æ•°è°ƒæ•´ï¼š
#    - feature_dim: 4096ï¼ˆåŒ¹é…ViT-7Bï¼‰
#    - é˜ˆå€¼æé«˜ï¼ˆè¡¥å¿éšæœºæƒé‡çš„ä¸ç¡®å®šæ€§ï¼‰
#    - æ›´ä¾èµ–objectness mapï¼ˆDINOv3çš„å¼ºé¡¹ï¼‰
# 
# 4. é¢„æœŸæ•ˆæœï¼š
#    - æ£€æµ‹æ¡†ï¼š5-20ä¸ªé«˜è´¨é‡å€™é€‰
#    - åˆ†å‰²ï¼šç²—ç³™ä½†åˆç†çš„å‰æ™¯åŒºåŸŸ
#    - SAM2ï¼šç²¾ç»†åŒ–ä¸ºé«˜è´¨é‡å®ä¾‹mask